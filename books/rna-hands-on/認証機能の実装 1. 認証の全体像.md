## この章でやること

今回実装するフロントエンドの認証機能の全体像を解説します。

## 前提 > RailsAPI における認証の仕組み

ここからは、Next.jsにおける認証機能の実装に入ります。まずおさらいとして Rails 側の認証に仕組みをおさらいします。

今回 Rails では devise_token_auth を用いた**トークン認証**機能を実装しています。トークン認証とは「フロントエンドから送信されたリクエストのヘッダーに、適切な組み合わせの認証情報（access-token, uid, client）が含まれていることを持って、認証ユーザーからのリクエストである、ということを判断する」という仕組みです。

認証情報は、ログインAPI（POST `/api/v1/auth`）に「メールアドレス」「パスワード」を送信することで取得することができます。これら認証情報を何らかの手段でブラウザ側に保存しておき、Railsにリクエストを送信する際に利用することによって、認証ユーザーとしてのリクエストを送ることが可能になります。

## フロントエンドの認証の全体像

Rails側の仕組みをおさらいした上で、今回のフロントエンドの認証の仕組みを説明します。

- **認証情報を取得する流れ**
  - ログインページからログインAPIを叩き、レスポンスから認証情報を取得する。
  - 取得した認証情報を、ブラウザ内のメモリ領域である`localStorage`に保存する。
- **認証情報を使用する流れ**
  - 全ページをラッピングしている`<Auth>`コンポーネント内で、`localStorage`に基づいてログインユーザーをAPIから取得する記述を行う
  - 取得したログインユーザーの情報を、 useSWR を用いて定義された global state として保存する
  - アクセスパスに応じたページが解釈されるとき、適宜 global state に保存された ログインユーザー情報を利用する

初見では理解するのが難しい箇所だと思いますので、補足を行います。

まず初めに、認証情報をRailsから取得するためのページとして、ログインページ（`/sign_in`）を実装します。ログインページには、「メールアドレス」と「パスワード」の入力フォームが設置されており、入力値をボディーパラメーターに含めた状態でログインAPI（POST `/api/v1/auth`）にリクエストを送信します。

Rails は、Next.jsから送られてきたメールアドレスとパスワードが適切であるかを判断し、適切な場合は認証情報（access-token, uid, client）を Next.js にレスポンスとして返します。

その後 Next.js では受け取ったレスポンスから認証情報を取り出し、これを`localStorage`に保存します。`localStorage`とは、ブラウザの中にある、任意の値を保存しておける領域です。

https://webliker.info/web-skill/how-to-use-localstrage/

つまりは、「ユーザーAさんがログインしていること」というのは、「ブラウザのメモリ領域である`localStorage`に、ユーザーAさんの認証情報が保存されていること」と言い換えられるということです。

ここまでで、**認証情報を取得する**が実現されます。

↓

**認証情報を利用する**役割として、`<Auth>`コンポーネントを追加します。`<Auth>`コンポーネントは全てのページにアクセスする際に動作するコンポーネントで、画面ロードが行われる際に`localStorage`に認証情報が含まれていた場合に、ログインユーザーを取得するAPI（GET /api/v1/current/user）を動作させます。

そして、Railsから受け取ったログインユーザーの情報を global state として保存します。 global state というのは、**任意のReactコンポーネントから参照することができる位置の保存されている変数**、といった意味の言葉です。

通常、ある React コンポーネントで定義したり取得したりした変数は、`props`の仕組みを使って子コンポーネント、孫コンポーネント、ひ孫コンポーネント、、、にバケツリレーの要領で渡すことができます。

しかし、ログインユーザーの情報はあらゆる React コンポーネントで使用され得るものです。ログインユーザー情報を使用するたびに`<Auth>`コンポーネントから子、孫、ひ孫、、、と渡していくのは、実装が非常に煩雑になってしまいます。

この props のバケツリレーを解決するのが global state というアイディアです。global state に保存された変数は、任意の React コンポーネントから直接呼び出すことができます。

`<Auth>`コンポーネントが取得したログインユーザー情報を global state として保存することによって、 props のバケツリレーなしに、すべての React コンポーネントがログインユーザーを自由に利用することができるようになります。

React の世界において global state を実装する手段はいくつかあるのですが、今回はすでにライブラリといて導入済みです**useSWR**を用いた方法をご紹介します。

↓

ログインユーザー情報を global state に保存できてしまえば、後はそれぞれの React コンポーネントで自由にログインユーザーの情報を利用できるようになります。

ユーザー名を表示したり、ログイン前後でデザインを切り替えたり、未ログインの場合にアクセス拒否したり、といったことが実現できるようになっていきます。

認証周りは新しい概念がいくつも出てきているので、初見でここのテキストを読んだだけでは全てを理解し切れないかと思います。まずは何となくの雰囲気の理解で構いませんで、次章から実際に実装を行なっていくことでだんだんと理解を深めるようにしていってください。
